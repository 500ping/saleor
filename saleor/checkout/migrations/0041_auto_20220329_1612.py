# Generated by Django 3.2.12 on 2022-03-29 16:12

from decimal import Decimal

import django.utils.timezone
from django.core.management.sql import emit_post_migrate_signal
from django.db import migrations, models


def set_default_checkout_line_currency(apps, schema_editor):
    CheckoutLine = apps.get_model("checkout", "CheckoutLine")
    lines = CheckoutLine.objects.select_related("checkout")

    for line in lines:
        line.currency = line.checkout.currency

    CheckoutLine.objects.bulk_update(lines, ["currency"])


def assign_permission(apps, schema_editor):
    # force post signal as permissions are created in post migrate signals
    # related Django issue https://code.djangoproject.com/ticket/23422
    emit_post_migrate_signal(2, False, "default")
    Permission = apps.get_model("auth", "Permission")
    App = apps.get_model("app", "App")
    Group = apps.get_model("auth", "Group")

    handle_taxes = Permission.objects.filter(
        codename="handle_taxes", content_type__app_label="checkout"
    ).first()
    manage_checkouts = Permission.objects.filter(
        codename="manage_checkouts", content_type__app_label="checkout"
    ).first()

    apps = App.objects.filter(
        permissions=manage_checkouts,
    )
    for app in apps.iterator():
        app.permissions.add(handle_taxes)

    groups = Group.objects.filter(
        permissions=manage_checkouts,
    )
    for group in groups.iterator():
        group.permissions.add(handle_taxes)


class Migration(migrations.Migration):

    dependencies = [
        ("checkout", "0040_add_handle_checkouts_permission"),
    ]

    operations = [
        migrations.AlterModelOptions(
            name="checkout",
            options={
                "ordering": ("-last_change", "pk"),
                "permissions": (
                    ("manage_checkouts", "Manage checkouts"),
                    ("handle_checkouts", "Handle checkouts"),
                    ("handle_taxes", "Handle taxes"),
                ),
            },
        ),
        migrations.RunPython(assign_permission),
        migrations.AddField(
            model_name="checkout",
            name="price_expiration",
            field=models.DateTimeField(default=django.utils.timezone.now),
        ),
        migrations.AddField(
            model_name="checkout",
            name="shipping_price_gross_amount",
            field=models.DecimalField(
                decimal_places=3, default=Decimal(0), max_digits=12
            ),
        ),
        migrations.AddField(
            model_name="checkout",
            name="shipping_price_net_amount",
            field=models.DecimalField(
                decimal_places=3, default=Decimal(0), max_digits=12
            ),
        ),
        migrations.AddField(
            model_name="checkout",
            name="shipping_tax_rate",
            field=models.DecimalField(
                decimal_places=4, default=Decimal("0.0"), max_digits=5
            ),
        ),
        migrations.AddField(
            model_name="checkout",
            name="subtotal_gross_amount",
            field=models.DecimalField(
                decimal_places=3, default=Decimal(0), max_digits=12
            ),
        ),
        migrations.AddField(
            model_name="checkout",
            name="subtotal_net_amount",
            field=models.DecimalField(
                decimal_places=3, default=Decimal(0), max_digits=12
            ),
        ),
        migrations.AddField(
            model_name="checkout",
            name="total_gross_amount",
            field=models.DecimalField(
                decimal_places=3, default=Decimal(0), max_digits=12
            ),
        ),
        migrations.AddField(
            model_name="checkout",
            name="total_net_amount",
            field=models.DecimalField(
                decimal_places=3, default=Decimal(0), max_digits=12
            ),
        ),
        migrations.AddField(
            model_name="checkoutline",
            name="currency",
            field=models.CharField(null=True, max_length=3),
        ),
        migrations.RunPython(set_default_checkout_line_currency),
        migrations.AlterField(
            model_name="checkoutline",
            name="currency",
            field=models.CharField(max_length=3),
        ),
        migrations.AddField(
            model_name="checkoutline",
            name="tax_rate",
            field=models.DecimalField(
                decimal_places=4, default=Decimal("0.0"), max_digits=5
            ),
        ),
        migrations.AddField(
            model_name="checkoutline",
            name="total_price_gross_amount",
            field=models.DecimalField(
                decimal_places=3, default=Decimal(0), max_digits=12
            ),
        ),
        migrations.AddField(
            model_name="checkoutline",
            name="total_price_net_amount",
            field=models.DecimalField(
                decimal_places=3, default=Decimal(0), max_digits=12
            ),
        ),
        migrations.AddField(
            model_name="checkoutline",
            name="total_price_with_discounts_gross_amount",
            field=models.DecimalField(
                decimal_places=3, default=Decimal(0), max_digits=12
            ),
        ),
        migrations.AddField(
            model_name="checkoutline",
            name="total_price_with_discounts_net_amount",
            field=models.DecimalField(
                decimal_places=3, default=Decimal(0), max_digits=12
            ),
        ),
        migrations.AddField(
            model_name="checkoutline",
            name="undiscounted_total_price_gross_amount",
            field=models.DecimalField(
                decimal_places=3, default=Decimal(0), max_digits=12
            ),
        ),
        migrations.AddField(
            model_name="checkoutline",
            name="undiscounted_total_price_net_amount",
            field=models.DecimalField(
                decimal_places=3, default=Decimal(0), max_digits=12
            ),
        ),
        migrations.AddField(
            model_name="checkoutline",
            name="undiscounted_unit_price_gross_amount",
            field=models.DecimalField(
                decimal_places=3, default=Decimal(0), max_digits=12
            ),
        ),
        migrations.AddField(
            model_name="checkoutline",
            name="undiscounted_unit_price_net_amount",
            field=models.DecimalField(
                decimal_places=3, default=Decimal(0), max_digits=12
            ),
        ),
        migrations.AddField(
            model_name="checkoutline",
            name="unit_price_gross_amount",
            field=models.DecimalField(
                decimal_places=3, default=Decimal(0), max_digits=12
            ),
        ),
        migrations.AddField(
            model_name="checkoutline",
            name="unit_price_net_amount",
            field=models.DecimalField(
                decimal_places=3, default=Decimal(0), max_digits=12
            ),
        ),
        migrations.AddField(
            model_name="checkoutline",
            name="unit_price_with_discounts_gross_amount",
            field=models.DecimalField(
                decimal_places=3, default=Decimal(0), max_digits=12
            ),
        ),
        migrations.AddField(
            model_name="checkoutline",
            name="unit_price_with_discounts_net_amount",
            field=models.DecimalField(
                decimal_places=3, default=Decimal(0), max_digits=12
            ),
        ),
    ]
